<link rel="import", href="../app/bower_components/polymer/polymer.html">
<script src="../app/bower_components/d3/d3.js"></script>

<polymer-element name="cth-barchart"
                 attributes="yValue chartData width">
  <template>
  </template>
  <script>
    var chart = {
      height: function(width) {
        return width / 3;
      },
      barSize: function(width, dataLength){
        return width / dataLength;
      }
    }

    Polymer("cth-barchart", {
      timeOut: null,
      chartData: [{resourceCount: 5}],
      init: function() {
        var self = this;
        this.height = chart.height(self.width);
        this.barSize = chart.barSize(self.width, self.chartData.length);

        console.log(this.shadowRoot);
        this.svg = d3.select(self.shadowRoot)
          .append('svg')
          .attr("width", self.width)
          .attr("height", self.height);

        this.yScale = d3.scale.linear()
          .domain([0, d3.max(self.chartData, function(d){
            return d[self.yValue];
           })])
           .range([0, self.height]);

        this.barScale = d3.scale.linear()
          .domain([0, d3.max(self.chartData, function(d){
            return d[self.yValue];
           })])
          .range([self.height, 0]);

        this.svg.selectAll("rect")
          .data(self.chartData)
          .enter()
          .append("rect")
          .attr("x", function(d,i){
            return i * self.barSize;
          })
         .attr("y", function(d){
           return self.barScale(d[self.yValue]);
         })
         .attr("width", self.barSize * 0.9)
         .attr("height", function(d){
           return self.yScale(d[self.yValue]);
         })
         .attr("fill", "teal")
        
        this.initialized = true;
      },
      resize: function() {
        var self = this;
        this.height = chart.height(self.width);
        this.svg
          .attr("width", self.width)
      },
      redraw: function() {
        var self = this;
        this.barSize = chart.barSize(self.width, self.chartData.length);

        bars = this.svg.selectAll("rect")
          .data(self.chartData)

        bars.enter()
          .append("rect")
          .attr("x", function(d,i){
            return self.width + self.barSize; 
          })
          .attr("y", function(d){
            return self.barScale(d[self.yValue]);
          })
          .attr("width", self.barSize * 0.9)
          .attr("height", function(d){
            return self.yScale(d[self.yValue]);
          })
          .attr("fill", "teal");
        
        bars.transition()
          .duration(500)
          .attr("x", function(d,i){
            return i * self.barSize; 
          })
          .attr("y", function(d){
            return self.barScale(d[self.yValue]);
          })
          .attr("width", self.barSize * 0.9)
          .attr("height", function(d){
            return self.yScale(d[self.yValue]);
          });
      },
      widthChanged: function() {
        if(!this.initialized) {
          this.init();
        } else {
          this.resize();
          this.redraw();
        }
      },
      chartDataChanged: function(){
        clearTimeout(this.timeOut);
        this.timeOut = setTimeout(this.redraw(), 100);
      }
    })
  </script>
</polymer-element>
