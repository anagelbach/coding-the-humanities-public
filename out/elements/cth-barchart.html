<link rel="import", href="../app/bower_components/polymer/polymer.html">
<script src="../app/bower_components/d3/d3.js"></script>

<polymer-element name="cth-barchart"
                 attributes="yValue chartData width">
  <template>
  </template>
  <script>
    var chart = {
      height: function() {
        return chart.width / 3;
      },
      barSize: function(){
        return chart.width / chart.data.length;
      },
      init: function(config) {
        chart.width = config.width;
        chart.data = config.data; 
        chart.yValue = config.yValue;
        
        chart.svg = d3.select(config.el)
          .append('svg')
          .attr("width", chart.width)
          .attr("height", chart.height());

        chart.yScale = d3.scale.linear()
          .domain([0, d3.max(chart.data, function(d){
            return d[chart.yValue];
           })])
           .range([0, chart.height()]);

        chart.barScale = d3.scale.linear()
          .domain([0, d3.max(chart.data, function(d){
            return d[chart.yValue];
           })])
          .range([chart.height(), 0]);

        chart.svg.selectAll("rect")
          .data(chart.data)
          .enter()
          .append("rect")
          .attr("x", function(d,i){
            return i * chart.barSize(); 
          })
         .attr("y", function(d){
           return chart.barScale(d[chart.yValue]);
         })
         .attr("width", chart.barSize() * 0.9)
         .attr("height", function(d){
           return chart.yScale(d[chart.yValue]);
         })
         .attr("fill", "teal")
      },
      resize: function(config) {
        chart.width = config.width || chart.width;
        chart.svg
          .attr("width", chart.width)
          .attr("height", chart.height)

        chart.yScale = d3.scale.linear()
          .domain([0, d3.max(chart.data, function(d){
            return d[chart.yValue];
           })])
           .range([0, chart.height()]);

        chart.barScale = d3.scale.linear()
          .domain([0, d3.max(chart.data, function(d){
            return d[chart.yValue];
           })])
          .range([chart.height(), 0]);
      },
      redraw: function(config) {
        chart.data = config.data;

        bars = chart.svg.selectAll("rect")
          .data(chart.data)

        bars.enter()
          .append("rect")
          .attr("x", function(d,i){
            return chart.width + chart.barSize(); 
          })
          .attr("y", function(d){
            return chart.barScale(d[chart.yValue]);
          })
          .attr("width", chart.barSize() * 0.9)
          .attr("height", function(d){
            return chart.yScale(d[chart.yValue]);
          })
          .attr("fill", "teal");
        
        bars.transition()
          .duration(500)
          .attr("x", function(d,i){
            return i * chart.barSize(); 
          })
          .attr("y", function(d){
            return chart.barScale(d[chart.yValue]);
          })
          .attr("width", chart.barSize() * 0.9)
          .attr("height", function(d){
            return chart.yScale(d[chart.yValue]);
          });
      }
    };

    Polymer("cth-barchart", {
      timeOut: null,
      chartData: [{resourceCount: 5}],
      widthChanged: function() {
        if(!chart.width) {
          chart.init({el: this.shadowRoot, data: this.chartData, yValue: this.yValue, width: this.width});
        } else {
          chart.resize({width: this.width});
          chart.redraw({data: this.chartData});
        }
      },
      chartDataChanged: function(){
        clearTimeout(this.timeOut);
        this.timeOut = setTimeout(chart.redraw({data: this.chartData}), 100);
      }
    })
  </script>
</polymer-element>
